# CodeDevil 作業ログ 2025年12月

## 2025-12-01 作業概要

### 天使のノート・悪魔のノート全面書き直し

#### 背景
- 既存の悪魔のノートは皮肉度にバラつきがあった（★★〜★★★★★）
- 天使のノートは003由来の10件のみで、しかも皮肉混じりだった
- 天使と悪魔の区別が曖昧になっていた

#### 方針決定
- **天使のノート**: 本当に役立つTips、ベストプラクティス、注意点
- **悪魔のノート**: 本物の皮肉（★★★★★レベル）、開発者あるある

#### 作業内容

1. **Phase 1: 天使のノート新規作成**
   - Python 53件
   - JavaScript 49件
   - Bash 39件

2. **Phase 2: 悪魔のノート書き直し**
   - Python 53件
   - JavaScript 49件
   - Bash 39件

3. **slug不一致問題の修正**
   - 最初のSQLで使用したslugがDBの実際のslugと一致していなかった
   - DBから実際のslug一覧を取得して照合
   - 全141エントリに対応した修正版SQLを作成

#### 作成したファイル

| ファイル | 説明 |
|---------|------|
| `supabase/migrations/011_clear_all_notes.sql` | 既存ノートクリア |
| `supabase/migrations/012_angel_notes_python.sql` | Python天使のノート（旧版） |
| `supabase/migrations/013_angel_notes_javascript.sql` | JavaScript天使のノート（旧版） |
| `supabase/migrations/014_angel_notes_bash.sql` | Bash天使のノート（旧版） |
| `supabase/migrations/015_devil_notes_python.sql` | Python悪魔のノート（旧版） |
| `supabase/migrations/016_devil_notes_javascript.sql` | JavaScript悪魔のノート（旧版） |
| `supabase/migrations/017_devil_notes_bash.sql` | Bash悪魔のノート（旧版） |
| `supabase/migrations/018_fix_all_notes.sql` | **修正版（全141件対応）** |

#### 技術的な学び

- **slug命名の重要性**: DBのslugと完全一致しないとUPDATE文がヒットしない
- **確認の重要性**: SQL作成前にDBの実際のデータを確認すべきだった
- **一括処理**: 最初にクリアしてから全件UPDATEする方式が安全

#### 次のアクション

- [x] `018_fix_all_notes.sql` をSupabase SQL Editorで実行
- [x] サイトで表示確認
- [x] Git commit & push

---

### GlobalSearch Bash検索対応

#### 問題
ホーム画面の検索でBashが候補に出てこなかった。

#### 原因
`GlobalSearch.tsx`がmockDataを直接インポートしていた。mockDataにはPython/JavaScriptしかなく、BashはSupabaseにのみ存在していた。

#### 修正
- mockDataインポートを削除
- `@/lib/supabase/client`を直接使用してSupabaseからデータ取得
- クライアントコンポーネントでは`server.ts`（next/headers依存）は使えないため、`client.ts`を使用

#### 学び
- サーバーコンポーネント用のSupabaseクライアント（`server.ts`）はクライアントコンポーネントからインポート不可
- クライアントコンポーネントでは`createBrowserClient`を使う`client.ts`を直接使用する

---

### 用語詳細ページ前後ナビゲーション追加

#### 要件
- 「一覧に戻る」リンク付近に「前の用語」「次の用語」を追加
- 循環ナビゲーション（先頭の「前」は末尾、末尾の「次」は先頭）

#### 実装
- `getEntriesByLanguage`で同言語の全エントリを取得
- 現在のエントリの位置から前後を計算（モジュロ演算で循環）
- UIは3カラムflex配置：左（前）、中央（一覧）、右（次）

#### 修正ファイル
- `src/app/[lang]/[slug]/page.tsx`

---

### 本日の成果まとめ

| 項目 | 内容 |
|------|------|
| 天使のノート | 141件全エントリに追加 |
| 悪魔のノート | 141件全エントリを★★★★★レベルに書き直し |
| バグ修正 | GlobalSearchでBashが出ない問題 |
| 機能追加 | 前後ナビゲーション |

### 次回予定
- 用語（エントリ）の追加

---

## 2025-12-01 作業概要（セッション2）

### 言語・エントリ大規模拡充

#### 背景
- 既存：Python 106件、JavaScript 98件、Bash 78件（計282件）
- 実用的な辞典にするため、新言語追加と既存言語拡充を計画

#### 計画策定
- TypeScript: 70件（JSとの差分、型システム特化）
- SQL: 80件（基本クエリ〜高度機能）
- HTML/CSS: 50件（1言語として統合）
- 既存言語拡充: 60件（Python +20, JS +25, Bash +15）
- **合計追加: 260件 → 最終542件**

#### 作成したマイグレーションファイル

| ファイル | 内容 |
|----------|------|
| `019_typescript_language.sql` | TypeScript言語・5カテゴリ・70エントリ |
| `020_sql_language.sql` | SQL言語・5カテゴリ・80エントリ |
| `021_html_css_language.sql` | HTML/CSS言語・5カテゴリ・50エントリ |
| `022_existing_expansion.sql` | 既存言語拡充・60エントリ |

#### Supabase CLI導入

1. `npm install supabase --save-dev` でプロジェクトローカルインストール
2. `npx supabase init` で初期化
3. `npx supabase login` でログイン
4. `npx supabase link --project-ref ginyzujmhlowxflslzvs` でリンク

#### マイグレーション履歴同期

問題: 過去のマイグレーション（001-018）がダッシュボードから手動実行されていたため、履歴テーブルに記録がなかった

対処:
```bash
npx supabase migration repair --status applied 001 002 003 004 005 006 007 008 009 010 011 012 013 014 015 016 017 018
```

追加問題: `007_python_only.sql`（重複ファイル）を削除

#### 残作業（次セッション）

- [ ] `npx supabase db push` でマイグレーション019-022を適用
- [ ] 動作確認（6言語・542エントリ表示）
- [ ] Git commit & push

#### 技術的な学び

- Supabase CLIはnpmグローバルインストール不可、プロジェクトローカルで`npx`経由が正解
- `migration repair --status applied` で既存マイグレーションを「適用済み」としてマーク可能
- 同じ番号のマイグレーションファイルが複数あるとエラーになる

---

## 2025-12-01 作業概要（セッション3）

### マイグレーション019-022適用完了

#### 方針変更
- Supabase CLIが「Initialising login role...」でハングする問題が発生
- Dashboard SQL Editorで手動実行に切り替え

#### エラー修正

1. **UUIDフォーマットエラー**
   - 原因: `ts111111-...`, `sq222222-...`, `hc333333-...`等は無効なUUID
   - UUIDは16進数（0-9, a-f）のみ使用可能
   - 修正: `ts*` → `a0*`, `sq*` → `b0*`, `hc*` → `c0*`, `py*` → `d0*`, `js*` → `e0*`

2. **ARRAYタイポ**
   - 原因: `ASSERT['...'` と書いてしまった（`ARRAY`の誤記）
   - 修正: `ASSERT` → `ARRAY`

3. **slug重複エラー**
   - 原因: Bashの`trap`エントリが既存データと重複
   - 修正: `trap` → `trap-signals`

#### 実行結果
- 019_typescript_language.sql ✅
- 020_sql_language.sql ✅
- 021_html_css_language.sql ✅
- 022_existing_expansion.sql ✅

#### クリーンアップ
- 古いマイグレーション（001-018）をローカルから削除
- Supabase CLIをプロジェクトからアンインストール（`npm uninstall supabase`）
- ホームディレクトリの不要な`node_modules`を削除

#### 技術的な学び

- **UUIDは16進数のみ**: `ts`, `sq`, `hc`等のプレフィックスは使えない
- **Supabase CLIのハング**: WSL環境との相性問題の可能性。Dashboard実行で回避可能
- **WSLファイル削除**: Windowsエクスプローラーで消せないシンボリックリンクは`rm -rf`で削除

#### 最終成果

| 言語 | エントリ数 |
|------|-----------|
| Python | 126 |
| JavaScript | 123 |
| Bash | 93 |
| TypeScript | 70 |
| SQL | 80 |
| HTML/CSS | 50 |
| **合計** | **542** |

---

## 2025-12-02 作業概要

### 悪魔のノート品質改善（Phase 6.1）

#### 問題
Phase 6で追加した新言語（TypeScript, SQL, HTML/CSS）の「悪魔のノート」が教科書的な記述になっていた。

**ダメな例（修正前）**:
```sql
ARRAY['SELECT * は本番で使うな、必要な列だけ指定しろ', 'UTF-8が標準']
```
→ ただの技術Tips

**良い例（目標）**:
```sql
ARRAY['デバッグの9割はprint()で始まりprint()で終わる。デバッガー？何それ美味しいの？',
      '本番環境に残したprint()が後輩に見つかる恐怖。']
```
→ 経験談・感情・皮肉・共感ポイント

#### 対象
| 言語 | エントリ数 |
|------|-----------|
| TypeScript | 70件 |
| SQL | 80件 |
| HTML/CSS | 50件 |
| **合計** | **200件** |

※ 022_existing_expansion.sql（既存言語拡充60件）は品質良好なため対象外

#### 作業内容
1. 200件全ての悪魔のノートを書き直し
2. 以下の要素を追加：
   - 開発者あるある
   - 感情表現（泣いた、恐怖、絶望）
   - 読者への語りかけ（〜よね？、〜だろ？）
   - 皮肉・毒舌
   - 失敗談・黒歴史

#### 作成したファイル
- `supabase/migrations/023_fix_sarcastic_notes.sql`（1410行）

#### 実行
- Supabase Dashboard SQL Editorで実行完了
- 「Query uses update without a where clause」警告は誤検知（実際は全てWHERE句付き）

#### 技術的な学び
- Supabase SQL Editorの警告は最初のコメント行だけ見て誤検知することがある
- 大量のUPDATE文でも一括実行可能

---

### スマホ対応（Phase 7）

#### 要件
- モバイル端末での表示を最適化
- ナビゲーション方式: ハンバーガーメニュー

#### 実装内容

1. **MobileMenuProvider**（新規作成）
   - React Contextでメニュー開閉状態を管理
   - `useMobileMenu`: Provider必須版
   - `useMobileMenuOptional`: Provider外でも使える版（Header用）

2. **Header修正**
   - ハンバーガーボタン追加（モバイルのみ表示、md未満）
   - 開閉状態に応じてアイコン切り替え（三本線 ↔ ×）

3. **Sidebar修正**
   - PC (md以上): 従来通り固定サイドバー
   - モバイル: オーバーレイ + スライドインアニメーション
   - 背景オーバーレイタップで閉じる
   - ページ遷移時に自動で閉じる

4. **言語ページ・エントリ詳細ページ**
   - MobileMenuProviderでラップ
   - パディング調整（px-4 md:px-6）
   - タイトルサイズ調整（text-2xl md:text-3xl）

5. **前後ナビゲーション**
   - モバイル: 縦スタック表示
   - PC: 横並び3カラム

6. **CodeBlock**
   - `overflow-x-auto` 追加（横スクロール対応）
   - フォントサイズ微調整（0.875rem → 0.75rem）

#### 修正ファイル一覧

| ファイル | 変更内容 |
|----------|----------|
| `src/components/layout/MobileMenuProvider.tsx` | 新規作成 |
| `src/components/layout/Header.tsx` | ハンバーガーボタン追加 |
| `src/components/layout/Sidebar.tsx` | モバイルオーバーレイ対応 |
| `src/app/[lang]/page.tsx` | Provider追加、レイアウト調整 |
| `src/app/[lang]/[slug]/page.tsx` | Provider追加、ナビゲーション調整 |
| `src/components/entry/CodeBlock.tsx` | 横スクロール対応 |
| `src/components/entry/EntryDetail.tsx` | タイトルサイズ調整 |

#### 技術的なポイント
- ブレークポイント: `md` (768px) でPC/モバイル切り替え
- トップページはサイドバーなし → MobileMenuProvider不要 → ハンバーガー非表示
- `useMobileMenuOptional`でProvider外でもエラーにならないよう設計

#### デプロイ
- Render（自動デプロイ）
